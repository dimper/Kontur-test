# Kontur-test
## Задание
Требуется подготовить окружение для .NET Core приложения на машине с ОС Windows используя Ansible роль  
## Описание приложения
В приложении две ветки - master и test. В master неработающий код. Цель - использовать ветку test  
**Приложение:**
- Требует версию runtime 3.0.0 или 3.1.0 иначе ошибка
- Подключается к серверу PostgreSQL используя следующие параметры подключения:
   ```
   имя пользователя - superuser
   пароль - SuperUser
   база данных - superdb
   хостнэйм - MyServer (localhost)
   порт сервера - 5430 (внимание! именно 5430 а не 5432)
   ```
- Проверяет версию PostgreSQL. Должна быть 11.7 иначе ошибка
- Создает новую БД ultradb.
- В новой БД создает таблицу и после дропает её  
- Дропает БД ultradb

Таким образом Приложение привязано к конкретному runtime и версии PostgreSQL
## Требования
Написать плэйбук с файлом зависимостей для выкачивания необходимой роли из [репозитория](https://github.com/dimper/Kontur-role.git).
Эта роль должна быть первым шагом в плэйбуке.  
Не использовать пакетные менеджеры типа Chocolatey и не использовать сторонние модули Ansible  
**Что должен делать полэйбук:**
- запускать роль [Kontur-role](https://github.com/dimper/Kontur-role.git) которая должна добавить в hostfile запись **127.0.0.1  MyServer**
- запускать роль для установки git из официального репозитория  
*Доп. задания: на вход роли подавать версию git (url для скачивания формируется внутри плэйбука). Также добавить имя пользователя, адрес электронной почты и автоматически добавлять их в настройки репозитория*
- запускать роль для клонирования данного репозиторий с .NET Core приложением с последующим переключением в ветку test. Назначить всем локальным пользователям полные права к папке с репозиторием.  
*Доп. задания: при обнаружении ранее выкачанного репозитория, делать pull из заданной ветки*
- запускать роль для установки .NET Core требуемой версии для сборки и запуска приложения  
*Доп. задание: на вход подавать список версий для установки сразу нескольких*
- запускать роль для установки ceрвера PostgreSQL требуемой версии с официального репозитория  
*Доп. задание: на вход роли подавать порт и версию PostgreSQL (url для скачивания формируется внутри плэйбука)*
- Подключаться к серверу PostgreSQL MyServer и создать требуемую БД и пользователя с максимальными правами  
*Доп. задание: на вход роли список имен баз данных и словарь(хэш таблицу) с описанием пользователя (имя пользователя, пароль, полномочия). У роли должна быть возможность создавать несколько БД и пользователей*
- запускать задание для скачивания зависимостей и сборки данного приложения в папку c:\app
- запуск приложения и вывод результата в консоль. Должно быть примерно следующее:
```
output.stdout: |2-
    Hello from SOME-COMPUTERNAME
    Runtime version - 3.0.0
    Try to connect to PostgreSQL with connection string:
    Host=MyServer;port=5430;Username=superuser;Password=SuperUser;Database=superdb
    PostgreSQL version: PostgreSQL 11.7, compiled by Visual C++ build 1914, 64-bit

    Try to add database ultradb
    ok.

    Try to add table test_table in ultradb
    ok.

    Try to drop table test_table in ultradb
    ok.

    Try to drop database ultradb
    ok.

    Done.
```
## Общее дополнительные пожелания
- Плэйбук должен быть максимально идемпотентным, т.е. при повторном запуске не должно возникать ошибок и повторные действия, не вносящие изменения, должны пропускаться.
- Оба секрета (пароль WinRM и пароль пользователя PostgreSQL) должны быть зашифрованы Ansible-vault
